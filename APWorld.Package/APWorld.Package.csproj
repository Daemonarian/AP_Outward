<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <ProjectGuid>{C30EAD44-EAAB-4EBB-8F56-EB594AC5E42A}</ProjectGuid>
        <TargetFramework>net8.0</TargetFramework>
        <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
        <CopyBuildOutputToOutputDirectory>false</CopyBuildOutputToOutputDirectory>
        <APWorldProjectDir>..\Archipelago</APWorldProjectDir>
        <APWorldSourceDir>$(APWorldProjectDir)\src\outward</APWorldSourceDir>
        <APWorldName>outward</APWorldName>
        <OutputZipName>$(APWorldName).apworld</OutputZipName>
        <StagingDir>$(Project)bin\staging</StagingDir>
        <OutputDir>build</OutputDir>
    </PropertyGroup>
    <Target Name="PackagePythonFiles" AfterTargets="Build">
        <Message Text="Packaging Python files..." Importance="high" />
        <RemoveDir Directories="$(StagingDir)" />
        <MakeDir Directories="$(StagingDir)\$(APWorldName)" />
        <ItemGroup>
            <PythonFiles
                Include="$(APWorldSourceDir)\**\*.*" 
                Exclude="$(APWorldSourceDir)\**\__pycache__\**;$(APWorldSourceDir)\**\.venv\**;$(APWorldSourceDir)\**\test\**" />
        </ItemGroup>
        <Copy
            SourceFiles="@(PythonFiles)" 
            DestinationFiles="@(PythonFiles->'$(StagingDir)\$(APWorldName)\%(RecursiveDir)%(Filename)%(Extension)')" />
        <Delete Files="$(OutputDir)\$(OutputZipName)" />
        <MakeDir Directories="$(OutputDir)" />
        <ZipDirectory
            SourceDirectory="$(StagingDir)" 
            DestinationFile="$(OutputDir)\$(OutputZipName)" />
        <Message Text="SUCCESS: Created $(OutputZipName)" Importance="High" />
    </Target>
    <Target Name="ExportApworldIds" AfterTargets="Build">
        <Message Text="Exporting APWorld IDs" Importance="high" />
        <PropertyGroup>
            <APWorldPython Condition="$([MSBuild]::IsOSPlatform('Windows'))">$(APWorldProjectDir)\.venv\Scripts\python.exe</APWorldPython>
            <APWorldPython Condition="!$([MSBuild]::IsOSPlatform('Windows'))">$(APWorldProjectDir)/.venv/bin/python</APWorldPython>
        </PropertyGroup>
        <Exec Command="&quot;$(APWorldPython)&quot; &quot;$(APWorldProjectDir)/src/export_ids.py&quot; --output &quot;$(OutputDir)/apworld_ids.json&quot;" />
    </Target>
</Project>